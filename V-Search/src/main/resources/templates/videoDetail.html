<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
	layout:decorate="~{layout/layout}">

<head>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body layout:fragment="content">
	<video width="640" height="480" controls>
		<source th:src="@{'data:video/mp4;base64,' + ${videoData}}" type="video/mp4">
		<!-- 다른 동영상 형식에 대한 소스 추가 -->
	</video>
	<!-- 추천 상태 및 추천 수를 표시할 영역 -->
	<div>
		<p>추천 상태: <span th:text="${recommendState}"></span></p>
		<p>추천 수: <span th:text="${recommendCount}"></span></p>
	</div>

	<form id="recommend" action="/video/104/recommend" method="post">
		<button type="submit" id="recommendButton">추천</button>
	</form>
	<!-- 추천 버튼 -->

	<!-- 추천 취소 버튼 -->
	<button id="cancelRecommendButton" onclick="cancelRecommend()">추천 취소</button>


	<script>
		// 현재 페이지 URL에서 동영상 번호를 추출하는 함수
		function extractVideoNoFromUrl() {
			var url = window.location.href;
			var parts = url.split("/");
			return parts[parts.length - 1]; // 마지막 부분을 동영상 번호로 가정
		}

		// 추천 버튼 클릭 시
		function recommend() {
			var videoNo = extractVideoNoFromUrl();

			// AJAX를 사용하여 POST 요청 보내기
			$.ajax({
				type: "POST",
				url: "/video/" + videoNo + "/recommend",
				success: function (response) {
					updateRecommendationInfo();
				},
				error: function (xhr, status, error) {
					console.error("추천에 실패했습니다.", error);
				}
			});
		}

		// 추천 취소 버튼 클릭 시
		function cancelRecommend() {
			var videoNo = extractVideoNoFromUrl();

			// AJAX를 사용하여 DELETE 요청 보내기
			$.ajax({
				type: "DELETE",
				url: "/video/" + videoNo + "/recommend",
				success: function (response) {
					console.log("추천이 취소되었습니다.");
					// 추천 취소가 성공했을 때 화면 업데이트
					updateRecommendationInfo();
				},
				error: function (xhr, status, error) {
					console.error("추천 취소에 실패했습니다.", error);
				}
			});
		}

		// 추천 상태 및 추천 수를 업데이트하는 함수
		function updateRecommendationInfo() {
			var videoNo = extractVideoNoFromUrl();

			// 추천 상태 및 추천 수를 업데이트하기 위해 AJAX를 사용하여 GET 요청 보내기
			$.ajax({
				type: "GET",
				url: "/video/" + videoNo + "/recommendation-info",
				success: function (response) {
					// 추천 상태 및 추천 수 업데이트
					$("#recommendState").text(response.recommendState);
					$("#recommendCount").text(response.recommendCount);
				},
				error: function (xhr, status, error) {
					console.error("추천 정보를 불러오는 데 실패했습니다.", error);
				}
			});
		}
	</script>
</body>

</html>