<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
	layout:decorate="~{layout/layout}">

<head>
	<meta charset="UTF-8">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/video.js/8.10.0/video-js.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/videojs-markers/0.7.0/videojs.markers.css" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/video.js/8.10.0/video.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-markers/0.7.0/videojs.markers.min.js"></script>
	<link rel="stylesheet" type="text/css" th:href="@{/detail.css}">
</head>

<body layout:fragment="content">
	<div class="btncontainer">
		<button class="btn front">
			<img th:src="@{/img/btn.png}" class="image-btn">
		</button>
		<button class="btn back" style="display: none;">
			<img th:src="@{/img/smybtn.png}" class="image-btn">
		</button>
	</div>
	<div class="main">
		<div class="container">
			<div class="card front-card">
				<video width="640" height="480" id="VideoPlayer" class="video-js vjs-default-skin">
					<source th:src="@{${scriptObj.SMYURL}}" type="video/mp4">
					요약영상
				</video>
			</div>
			<div class="card back-card">
				<video width="640" height="480" id="VideoPlayer2" class="video-js vjs-default-skin">
					<source th:src="@{${scriptObj.STOURL}}" type="video/mp4">
					원본 영상
				</video>
			</div>
		</div>
		<div id="smyscript"></div>
		<div id="summarymain" style="display: none;">
			<div class="smybtn">
				<button class="user" th:onclick="checks()">사용자 요약</button>
				<button class="search" th:onclick="searchs()">검색</button>
			</div>
			<div id="summaryobject">
				<div id="checkboxCard">
					<p th:attr="scriptObj=${scriptObj.videoObj}" style="display: none;"></p>
				</div>
			</div>
			<div>
				<div id="searchsmy" style="display: none;">
					<form>
						<input id="searchInput" type="text" placeholder="검색">
					</form>
					<div id="resultsContainer">
						<div th:each="SMYresult:${SMYresult}">
							<p>
								<span th:text="${#strings.substring(SMYresult.TIMELINE, 11)} + ' ' + ${SMYresult.CAPTION}" class="videoLink"></span>
							</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="button-container">
		<form th:action="@{'/recommend/toggle/'+ ${videoNo}}" method="POST">
			<button type="submit" class="recommend-button">추천</button>
		</form>

		<form th:action="@{'/delvideos/' + ${videoNo}}" method="POST">
			<input type="hidden" name="_method" value="DELETE">
			<input type="submit" value="동영상 삭제" class="delete-video-button">
		</form>

		<form th:action="@{'/api/subscribe/'+${videoNo}}" method="POST">
			<button type="submit" id="subscribe" class="subscribe-button">구독</button>
		</form>

		<form th:action="@{'/api/subscribe/'+${videoNo}}" method="GET">
			<button type="submit" id="unsubscribe" class="unsubscribe-button" style="display: none">구독취소</button>
		</form>
	</div>

	<p>구독자 수 : <span th:text="${userDto.subscribeCount}"></span></p>
	<p>추천 수 : <span th:text="${recommendationsCount}"></span></p>

	<form th:action="@{'/comments/create/'+${videoNo}}" method="POST">
		<input type="hidden" name="videoNo" th:value="${videoNo}">
		<textarea name="content" placeholder="Enter your comment" required></textarea><br>
		<button type="submit" class="submit-comment-button">Submit</button>
	</form>

	<div th:each="comment : ${comments}">
		<p th:text="${comment.content}"></p>
		<!-- 삭제 버튼 -->
		<form th:action="@{'/comments/' + ${videoNo} + '/' + ${comment.id}}" method="POST">
			<input type="hidden" name="_method" value="delete" />
			<input type="submit" value="삭제" class="delete-comment-button" />
		</form>
	</div>

	<button id="showSectionsButton">Show Selected Sections</button>
	<div id="selectedSectionsContainer"></div>

	<script>
		var player1, player2;
		$(document).ready(function () {
			$('.front').on('click', function () {
				$('.front').hide();
				$('.back').show();
				$('#summarymain').show();
				$('.card').addClass('active');
				var player = videojs('VideoPlayer');
				player.pause();
			});

			$('.back').on('click', function () {
				$('.front').show();
				$('.back').hide();
				$('.card').removeClass('active');
				$('#summarymain').hide();
				var player = videojs('VideoPlayer2');
				player.pause();
			});

			player1 = videojs("VideoPlayer", {
				controls: true,
				playsinline: true,
				preload: "auto",
				controlBar: {
					playToggle: true,
					pictureInPictureToggle: true,
					remainingTimeDisplay: true,
					progressControl: true
				}
			});

			player2 = videojs("VideoPlayer2", {
				controls: true,
				playsinline: true,
				preload: "auto",
				controlBar: {
					playToggle: true,
					pictureInPictureToggle: true,
					remainingTimeDisplay: true,
					progressControl: true
				}
			});

			// 체크박스 생성
			var scriptObjData = document.getElementById("checkboxCard").querySelector("p").getAttribute("scriptObj");
			if (scriptObjData) {
				var words = scriptObjData.split(", ");
				words.forEach(function (word) {
					var checkbox = document.createElement('input');
					checkbox.type = "checkbox";
					checkbox.value = word;
					checkbox.id = word;
					checkbox.onchange = updateSelectedWords;

					var label = document.createElement('label');
					label.htmlFor = word;
					label.appendChild(document.createTextNode(word));

					document.getElementById('checkboxCard').appendChild(checkbox);
					document.getElementById('checkboxCard').appendChild(label);
					document.getElementById('checkboxCard').appendChild(document.createElement('br'));
				});
			}

			$('#showSectionsButton').on('click', function () {
				var selectedCaptions = [];
				$('#checkboxCard input[type="checkbox"]:checked').each(function () {
					selectedCaptions.push($(this).val());
				});
				showSelectedSections(selectedCaptions);
			});

			var sections = [];

			function showSelectedSections(selectedCaptions) {
				sections = [];
				var scriptObjData = document.getElementById("checkboxCard").querySelector("p").getAttribute("scriptObj");
				var scriptArray = scriptObjData.split(', ');

				scriptArray.forEach(function (caption) {
					if (selectedCaptions.includes(caption)) {
						var timeComponents = caption.split(':');
						var time = 0;
						if (timeComponents.length === 3) {
							time = parseInt(timeComponents[0]) * 3600 + parseInt(timeComponents[1]) * 60 + parseInt(timeComponents[2]);
						} else if (timeComponents.length === 2) {
							time = parseInt(timeComponents[0]) * 60 + parseInt(timeComponents[1]);
						}
						sections.push({ start: time, end: time + 5 });
					}
				});

				updateSections();
			}

			function updateSections() {
				var curIndex = 0;
				player2.markers.destroy(); // 기존 마커 제거

				player2.markers({
					markerTip: {
						display: true,
						text: function (marker) {
							return marker.text;
						},
						time: function (marker) {
							return marker.time;
						}
					},
					markers: sections.map(function (section) {
						return { time: section.start, text: '' };
					})
				});

				player2.on('timeupdate', function () {
					var currentTime = player2.currentTime();
					if (curIndex < sections.length && currentTime >= sections[curIndex].end) {
						curIndex++;
						if (curIndex < sections.length) {
							player2.currentTime(sections[curIndex].start);
							player2.play();
						} else {
							player2.pause();
						}
					}
				});
			}

			function updateSelectedWords() {
				var selectedWords = [];
				words.forEach(function (word) {
					if (document.getElementById(word).checked) {
						selectedWords.push(word);
					}
				});
				document.getElementById("selectedWords").innerText = selectedWords.join(", ");
			}
		});
	</script>

</body>

</html>
