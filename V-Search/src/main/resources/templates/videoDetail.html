<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net/thymeleaf/layout"
	layout:decorate="~{layout/layout}">

<head>
	<meta charset="UTF-8">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/video.js/8.10.0/video-js.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/videojs-markers/0.7.0/videojs.markers.css" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/video.js/8.10.0/video.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-markers/0.7.0/videojs-markers.min.js"></script>
	<link rel="stylesheet" type="text/css" th:href="@{/detail.css}">
</head>

<body layout:fragment="content">
	<div class="btncontainer">
		<button class="btn front">
			비요약
		</button>
		<button class="btn back" style="display: none;">
			요약
		</button>
	</div>
	<div class="main">
		<div class="container">
			<div class="card front-card">
				<video width="640" height="480" id="VideoPlayer" class="video-js vjs-default-skin">
					<source th:src="@{'data:video/mp4;base64,' + ${videoData}}" type="video/mp4">
					요약영상
				</video>
			</div>
			<div class="card back-card">
				<video width="640" height="480" id="VideoPlayer2" class="video-js vjs-default-skin">
					<source
						th:src="@{'https://objectstorage.ap-chuncheon-1.oraclecloud.com/n/axekzvuz7vol/b/bucket-20240503-1000/o/test.mp4'}"
						type="video/mp4">
					원본 영상
				</video>
			</div>
		</div>
		<div class="summury">
			<div id="checkboxCard" style="display: none;">
			</div>
		</div>
	</div>
	<form th:action="@{'/recommend/toggle/'+ ${videoNo}}" method="POST">
		<button type="submit">추천</button>
	</form>
	<form th:action="@{'/delvideos/' + ${videoNo}}" method="POST">
		<input type="hidden" name="_method" value="DELETE">
		<input type="submit" value="동영상 삭제">
	</form>

	<div>
		<form th:action="@{'/api/subscribe/'+${videoNo}}" method="POST">
			<button type="submit" id="subscribe">구독</button>
		</form>
		<form th:action="@{'/api/subscribe/'+${videoNo}}" method="GET">
			<button type="submit" id="unsubscribe">구독취소</button>
		</form>
	</div>
	<p>구독자 수 : <span th:text="${userDto.subscribeCount}"></span></p>
	<p>추천 수 : <span th:text="${recommendationsCount}"></span></p>



	<!-- 댓글 입력 폼 -->
	<h2>Add Comment</h2>
	<form th:action="@{'/comments/create/'+${videoNo}}" method="POST">
		<input type="hidden" name="videoNo" th:value="${videoNo}">
		<textarea name="content" placeholder="Enter your comment" required></textarea><br>
		<button type="submit">Submit</button>
	</form>

	<div th:each="comment : ${comments}">
		<p th:text="${comment.content}"></p>
		<!-- 삭제 버튼 -->
		<form th:action="@{'/comments/' + ${videoNo} + '/' + ${comment.id}}" method="POST">
			<input type="hidden" name="_method" value="delete" />
			<input type="submit" value="삭제" />
		</form>
	</div>


	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script>
		$(document).ready(function () {
			$('.front').on('click', function () {
				$('.front').hide();
				$('.back').show();
				$('#checkboxCard').show();
				$('.card').addClass('active');
				var player = videojs('VideoPlayer');
				player.pause();
			});

			$('.back').on('click', function () {
				$('.front').show();
				$('.back').hide();
				$('.card').removeClass('active');
				$('#checkboxCard').hide();
				var player = videojs('VideoPlayer2');
				player.pause();
			});

			$('.subscribe').on('click', function () {
				$('.unsubscribe').show();
				$('.subscribe').hide();
			});
			$('.unsubscribe').on('click', function () {
				$('.subscribe').show();
				$('.unsubscribe').hide();
			});

			// 영상 파트 설정
			var parts = [
				{start: 0, end: 30},  // 파트 1: 0초부터 30초까지
				{start: 60, end: 90}, // 파트 2: 1분부터 1분 30초까지
				{start: 120, end: 150} // 파트 3: 2분부터 2분 30초까지
			];

			// 요약 영상 재생 버튼
			$('.front').on('click', function () {
				playParts('VideoPlayer', parts);
			});

			// 원본 영상 재생 버튼
			$('.back').on('click', function () {
				var player2 = videojs('VideoPlayer2');
				player2.play();
			});

			// Video.js를 이용하여 파트 재생
			function playParts(playerId, parts) {
				var player = videojs(playerId);
				player.pause(); // 영상 일시 중지

				// 각 파트를 순회하면서 재생
				parts.forEach(function (part) {
					player.currentTime(part.start); // 해당 파트의 시작 시간으로 이동
					player.play(); // 영상 재생

					// 파트 종료 시간에 도달하면 영상 일시 중지
					player.on('timeupdate', function () {
						if (player.currentTime() >= part.end) {
							player.pause();
						}
					});
				});
			}
		});
	</script>

</body>

</html>